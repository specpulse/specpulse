[command]
name = "sp-spec"
description = "Create and manage specifications without SpecPulse CLI"
version = "1.0"

[command.usage]
pattern = "/sp-spec [action] [description|feature-name]"
examples = [
  "/sp-spec create user authentication with JWT tokens",
  "/sp-spec update",
  "/sp-spec validate",
  "/sp-spec clarify"
]

[command.implementation]
# When called with "/sp-spec {{args}}, I will:

[command.implementation.argument_parsing]
# Parse arguments to determine action:
# - If first argument is create, update, validate, or clarify → Use that action
# - If no action specified → Default to create
# - For create → All remaining text becomes the description
# - For other actions → Look for feature name or use current feature

[command.implementation.feature_context]
# Detect Current Feature Context:
# - Check .specpulse/memory/context.md for active feature
# - Look for most recently modified spec/plan/task directory
# - Validate feature directory exists and is properly structured
# - Extract feature ID and name from directory structure

[command.implementation.spec_creation]
# For Action: create (default):

[command.implementation.spec_creation.universal_id]
# Generate Next Spec Number (Universal ID System):
# - Use Glob tool to scan .specpulse/specs/[feature]/ directory
# - Parse all existing spec-###.md files to extract numbers
# - Convert to integers and find the maximum value
# - Generate next sequential number: next_num = max_num + 1
# - Zero-pad to 3 digits: format(next_num, '03d') → 001, 002, 003
# - Validate no conflicts exist before using the number
# - Handle edge cases: empty directory, corrupted files, numbering gaps

[command.implementation.spec_creation.template_system]
# Read Template and Expand with AI:
# - Load .specpulse/templates/spec.md template file
# - If template missing, create comprehensive specification structure
# - Based on description, generate complete specification:
#   - Executive Summary: Clear problem statement and solution overview
#   - Functional Requirements: Detailed feature breakdown with acceptance criteria
#   - User Stories: Given-When-Then format with concrete scenarios
#   - Technical Constraints: Performance, security, and scalability requirements
#   - Non-Functional Requirements: Usability, accessibility, maintainability
#   - Risk Assessment: Potential technical and business risks
#   - Success Metrics: Measurable criteria for completion

[command.implementation.spec_creation.file_operations]
# Write Specification File:
# - Create .specpulse/specs/[feature]/spec-[###].md with generated content
# - Use atomic file operations to prevent corruption
# - Include proper YAML frontmatter with metadata
# - Validate file permissions and access rights

[command.implementation.spec_update]
# For Action: update:
# - List all specification files in current feature
# - Allow user to select which spec to update
# - Parse existing content and identify sections needing updates
# - Generate updated content based on new requirements
# - Preserve existing structure while enhancing content

[command.implementation.spec_validation]
# For Action: validate:
# - Check specification file exists and is readable
# - Validate required sections are present:
#   - Executive Summary ✓
#   - Functional Requirements ✓
#   - User Stories ✓
#   - Acceptance Criteria ✓
#   - Technical Constraints ✓
# - Count any [NEEDS CLARIFICATION] markers
# - Verify Given-When-Then format in user stories
# - Calculate completeness percentage
# - Identify missing or incomplete sections

[command.implementation.spec_clarification]
# For Action: clarify:
# - Scan specification for [NEEDS CLARIFICATION:...] patterns
# - Extract each question with surrounding context
# - Ask user for resolution on each clarification
# - Replace markers with ✅ **CLARIFIED**: [answer] format
# - Update specification with resolved clarifications

[command.implementation.ai_content_analysis]
# AI-Powered Content Analysis:
# - Project Type Detection (Web Application, API Service, Mobile App, CLI Tool, Data Pipeline, Library/SDK)
# - Complexity Assessment (Simple 2-4 hours, Standard 8-12 hours, Complex 16-24 hours)
# - Requirement Expansion based on project type
# - SDD Gates Compliance (Specification First, Traceable, Testable, Complete)

[command.implementation.safe_operations]
# Safe File Operations:
# - Validate file paths within allowed directories only
# - Use atomic write operations to prevent corruption
# - Create directory structure if missing
# - Backup existing files before updates
# - Validate file permissions and access rights

[command.implementation.context_management]
# Context Management:
# - Update .specpulse/memory/context.md with feature changes
# - Track specification history and decisions
# - Link related specifications, plans, and tasks
# - Maintain searchable decision log

[command.implementation.error_handling]
# Error Handling and Recovery:
# - Validation Errors (No active feature, Permission denied, Invalid feature name, Template missing)
# - Content Issues (Vague description, Conflicting requirements, Missing dependencies)
# - File Structure Problems (Missing directories, File permission errors, Invalid file formats)

[command.features]
# CLI-Independent Features:
# - No CLI Dependencies: 100% independent of SpecPulse CLI installation
# - Manual Specification Parsing: Direct file content analysis without CLI
# - Atomic File Updates: Safe file operations prevent corruption
# - Progress Tracking: Manual calculation from specification files
# - Error Recovery: Comprehensive error handling

[command.advanced_features]
# Enhanced Specification Generation:
# - AI-Powered Content Analysis with project type detection
# - SDD Gates Compliance with comprehensive validation
# - Template System Integration with fallback structures
# - Context Management with decision tracking
# - Multi-language support for international teams

[command.quality_assurance]
# Quality Assurance Features:
# - Comprehensive validation with detailed metrics
# - Requirements traceability matrix
# - Acceptance criteria testability verification
# - Risk assessment with mitigation strategies
# - Success metrics definition and tracking