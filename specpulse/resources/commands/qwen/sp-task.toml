description = "Create and manage tasks without SpecPulse CLI"

prompt = """
## Command: /sp-task [action] [feature-directory]

**CLI-Independent Task Lifecycle Management**

When called with `/sp-task {{args}}`, I will:

### Step 1: Detect Current Feature Context

**I will identify the current working feature:**
- Check `.specpulse/memory/context.md` for active feature
- Look for most recently modified spec/plan/task directory
- Validate feature directory exists and is properly structured
- Extract feature ID and name from directory structure

### Step 2: Parse Arguments to Determine Action

**Parse the command arguments:**
- If first argument is breakdown, update, status, execute, or validate → Use that action
- If no action specified → Default to breakdown
- For other arguments → Look for feature name or use current feature

### Step 3: For Action: breakdown (default)

**I will create comprehensive task breakdowns:**

#### A. Check for Service Decomposition
- Look for `.specpulse/specs/[feature]/decomposition/` directory
- If decomposition exists, identify service directories
- Parse service names for task categorization
- Plan service-specific task generation

#### B. Generate Task Breakdown
- Read implementation plan from `.specpulse/plans/[feature]/` directory
- Analyze plan phases and identify implementation steps
- Create detailed tasks with proper dependencies
- Assign task IDs using universal numbering system

#### C. Create Service-Specific Tasks
If decomposition exists:
- **Auth Service Tasks**: AUTH-T001, AUTH-T002, etc.
- **User Service Tasks**: USER-T001, USER-T002, etc.
- **Integration Tasks**: INT-T001, INT-T002, etc.

#### D. Generate Comprehensive Task Metadata
For each task, I will include:
- **Task ID**: Unique identifier with sequential numbering
- **Status**: Initially set to "todo"
- **Title**: Clear, actionable task description
- **Description**: Detailed "what, why, how, when" explanation
- **Files Touched**: List of files that will be modified
- **Goals**: Specific objectives this task achieves
- **Success Criteria**: Testable completion conditions
- **Dependencies**: Tasks that must be completed first
- **Next Tasks**: Tasks that can start after this one
- **Risk Level**: Assessment of potential issues (low/medium/high)
- **Risk Notes**: Specific concerns and mitigation strategies
- **MOSCOW Analysis**: Must/Should/Know/Won't categorization
- **Priority**: Overall priority ranking with reasoning
- **SDD Gates Compliance**: Specification-driven validation

#### E. Universal ID System Implementation
**Task ID Generation Algorithm:**
- Use Glob tool to scan `.specpulse/tasks/[feature]/` directory
- Parse existing task files to extract current numbering:
  - Global tasks: Extract numbers from `T###.md` patterns
  - Service tasks: Extract from `SERVICE-T###.md` patterns
  - Integration tasks: Extract from `INT-T###.md` patterns
- Create numbering map: `{task_type: max_number_used}`
- Generate next ID: For each task type, use `max_num + 1`
- Zero-pad format: `format(next_num, '03d')` ensures `001`, `002`, `003`

**Service-Specific Task Patterns:**
- **Authentication Service**: `AUTH-T001.md`, `AUTH-T002.md`, etc.
- **User Management Service**: `USER-T001.md`, `USER-T002.md`, etc.
- **API Gateway Service**: `GATEWAY-T001.md`, `GATEWAY-T002.md`, etc.
- **Database Service**: `DB-T001.md`, `DB-T002.md`, etc.
- **Notification Service**: `NOTIF-T001.md`, `NOTIF-T002.md`, etc.

### Step 4: For Action: update

**I will update existing task files:**
- Scan `.specpulse/tasks/[feature]/` directory for task files
- Display available task files for selection
- Parse current task structure and status
- Provide interactive update options:
  - Mark tasks as completed/in-progress/blocked
  - Update task descriptions or metadata
  - Add new tasks or remove obsolete ones
- Recalculate progress metrics after updates

### Step 5: For Action: status

**I will display comprehensive progress:**
- Scan all task files in current feature
- Calculate completion percentages
- Show progress by service (if decomposed)
- Display task status distribution:
  - Completed tasks count and percentage
  - In-progress tasks
  - Blocked tasks with blockers listed
  - Pending tasks available for work
- Show SDD Gates compliance status
- Calculate velocity metrics (tasks/day)
- Identify parallel tasks and sequential chains
- Provide recommendations for next actions

### Step 6: For Action: execute

**I will execute specific tasks:**
- Allow task selection from available pending tasks
- Validate task readiness and dependencies
- Display task details before execution
- Implement task requirements through code changes
- Test implementation when applicable
- Mark task as completed automatically
- Continue with next available task if requested
- Update progress metrics and context

### Step 7: For Action: validate

**I will perform comprehensive task validation:**
- Validate task file structure and format
- Check required fields are present and valid
- Verify task dependencies exist and are valid
- Validate SDD Gates compliance
- Check for duplicate task IDs
- Verify success criteria are testable
- Assess risk levels and mitigation strategies
- Report validation results with fixes needed

## Enhanced Task Generation

### Service-Specific Task Organization

**For decomposed features:**
- **Authentication Service**: JWT, OAuth, password policies, session management
- **User Management Service**: Profiles, preferences, permissions, roles
- **API Gateway Service**: Rate limiting, authentication, routing, logging
- **Database Service**: Schema management, migrations, backups, optimization
- **Notification Service**: Email, SMS, push notifications, templates
- **Integration Tasks**: Service communication, data synchronization, API contracts

### SDD Gates Compliance

**Every generated task meets:**
- ✅ **Specification Traced**: Links to specific requirements
- ✅ **Task Decomposed**: Complex work broken into manageable pieces
- ✅ **Quality Assurance**: Success criteria are testable
- ✅ **Traceable Implementation**: Clear link between tasks and code

## Progress Tracking and Analytics

### Comprehensive Metrics

**I track detailed progress:**
- Total tasks and completion percentage
- Task status distribution (todo/in-progress/blocked/done)
- Velocity calculations (tasks per day)
- Estimated completion dates based on velocity
- Parallel task availability
- Sequential dependency chains
- SDD Gates compliance percentage

### Risk Assessment

**I identify and track risks:**
- High-risk tasks with mitigation strategies
- Dependency chain vulnerabilities
- Resource allocation issues
- Timeline bottlenecks
- Technical debt accumulation

## Error Handling and Recovery

### Validation Errors
- **No active feature**: Prompt to run `/sp-pulse` first
- **Missing plan file**: Guide user to create plan with `/sp-plan`
- **Invalid task format**: Identify and fix structural issues
- **Circular dependencies**: Detect and resolve dependency loops
- **Missing specifications**: Link tasks back to requirements

### Execution Issues
- **Task blockers**: Identify dependencies and provide resolution paths
- **Failed implementations**: Rollback changes and retry with different approach
- **Test failures**: Debug and fix implementation issues
- **Resource conflicts**: Reschedule tasks to avoid conflicts

This `/sp-task` command provides **complete task lifecycle management** without requiring any SpecPulse CLI installation, using only validated file operations and comprehensive project analytics.
"""